FROM 763104351884.dkr.ecr.eu-west-2.amazonaws.com/huggingface-pytorch-inference:2.0.0-transformers4.28.1-cpu-py310-ubuntu20.04-v1.3

# Use bash so conda is available
SHELL ["/bin/bash", "-c"]

# Ensure we know the environment name:
ENV ENV_NAME="huggingface_py310"

# Make sure the environmentâ€™s bin is on PATH for subsequent RUN commands
ENV PATH="/opt/conda/envs/${ENV_NAME}/bin:$PATH"

# (Optional) show us which conda env is active
RUN conda env list

# 1) Install pinned Transformers, Sentence Transformers, plus Faiss in the correct env
RUN conda run -n $ENV_NAME pip install --no-cache-dir \
      "transformers==4.28.1" \
      "sentence-transformers<2.2.0" \
      "faiss-cpu==1.7.3"

# 2) Now force-upgrade huggingface-hub so snapshot_download is available
RUN conda run -n $ENV_NAME pip install --no-cache-dir --upgrade --force-reinstall huggingface-hub==0.15.1

# 3) Verify huggingface-hub version
RUN conda run -n $ENV_NAME pip show huggingface-hub
RUN conda run -n $ENV_NAME python -c "import huggingface_hub; print('huggingface_hub version:', huggingface_hub.__version__)"

# 4) Copy your custom inference script
COPY inference.py /opt/ml/model/code/inference.py

# 5) Environment variables
ENV PYTHONUNBUFFERED=TRUE
ENV PYTHONDONTWRITEBYTECODE=TRUE

ENV FAISS_INDEX_S3="s3://aym-client-data-in/rag/faiss_index.bin"
ENV METADATA_S3="s3://aym-client-data-in/rag/index_metadata.json"
ENV EMBED_MODEL_NAME="sentence-transformers/all-MiniLM-L6-v2"
ENV GEN_MODEL_NAME="my_summarization_model"

